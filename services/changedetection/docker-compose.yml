services:
  changedetection:
    image: ghcr.io/dgtlmoon/changedetection.io:latest
    container_name: ${STACK_NAME_PREFIX:-homelab}-changedetection
    depends_on:
      browser-sockpuppet-chrome:
        condition: service_started
    labels:
      # Homepage
      - homepage.group=Monitoring
      - homepage.name=ChangeDetection
      - homepage.icon=mdi-bell-alert-outline
      - homepage.href=https://${CHANGEDETECTION_SUBDOMAIN:-changedetection}.${BASE_DOMAIN}
      - homepage.description=Monitor websites for content changes
      # Traefik
      - traefik.enable=true
      - traefik.http.routers.changedetection.rule=Host(`${CHANGEDETECTION_SUBDOMAIN:-changedetection}.${BASE_DOMAIN}`)
      - traefik.http.routers.changedetection.entrypoints=websecure
      - traefik.http.routers.changedetection.tls.certresolver=cloudflare
      - traefik.http.services.changedetection.loadbalancer.server.port=5000
    ports:
      - "${CHANGEDETECTION_PORT:-5000}:5000"
    env_file:
      - ../../.env.changedetection
    volumes:
      - changedetection_data:/datastore
    networks:
      - traefik
      - changedetection
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://127.0.0.1:5000/', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  browser-sockpuppet-chrome:
    image: dgtlmoon/sockpuppetbrowser:latest
    container_name: ${STACK_NAME_PREFIX:-homelab}-changedetection-browser
    hostname: browser-sockpuppet-chrome
    env_file:
      - ../../.env.changedetection
    cap_add:
      - SYS_ADMIN
    networks:
      - changedetection
    restart: unless-stopped

networks:
  traefik:
    external: true
  changedetection:

volumes:
  changedetection_data:
